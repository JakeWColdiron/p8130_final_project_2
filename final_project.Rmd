---
title: "Final Project"
output: github_document
---

```{r}
library(gtsummary)
library(tidyverse)
library(car)
library(caret)
library(corrplot)



knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

theme_set(theme_minimal() + theme(legend.position = "bottom"))

```

```{r}
data = read_csv("./data/data.csv") |>
  janitor::clean_names()

summary(data)

str(data)
```

```{r}
# Check for missing data
colSums(is.na(data))
```

```{r}
# Convert character to factor for regression analysis
clean_data = data |>
  mutate(
    race = as.numeric(factor(race, levels = c("White", "Black", "Other"))) - 1,
    marital_status = as.numeric(factor(marital_status, levels = c("Married", "Single", "Divorced", "Widowed", "Separated"))) - 1,
    t_stage = as.numeric(factor(t_stage, levels = c("T1", "T2", "T3", "T4"))) - 1,
    n_stage = as.numeric(factor(n_stage, levels = c("N1", "N2", "N3"))) - 1,
    x6th_stage = as.numeric(factor(x6th_stage, levels = c("IIA", "IIB", "IIIA", "IIIB", "IIIC"))) - 1,
    differentiate = as.numeric(factor(differentiate, levels = c("Undifferentiated", "Poorly differentiated", "Moderately differentiated", "Well differentiated"))) - 1,
    grade = as.numeric(factor(grade, levels = c("1", "2", "3", "anaplastic; Grade IV"))),
    a_stage = as.numeric(factor(a_stage, levels = c("Regional", "Distant"))) - 1,
    estrogen_status = as.numeric(factor(estrogen_status, levels = c("Negative", "Positive"))) - 1,
    progesterone_status = as.numeric(factor(progesterone_status, levels = c("Negative", "Positive"))) - 1,
    status = as.numeric(factor(status, levels = c("Dead", "Alive"))) - 1)|>
  rename(regional_node_positive = reginol_node_positive)

summary(clean_data)
str(clean_data)

colSums(is.na(clean_data))
```



#Figure 1 
```{r}
proj2 = data |>
tbl_summary(by="status",
  missing_text = "(Missing)", # counts missing values
  statistic = list(all_continuous() ~ "mean={mean} (min={min}, max={max}, sd={sd})",
                   all_categorical() ~ "n={n} (p={p}%)") # stats for categorical
 # specify variables to include
  ) |>
bold_labels()  |>
italicize_levels()

```

#Find correlation
```{R}

corplot=cor(clean_data)
corrplot(corplot)
#tumor_size vs t_stage = 0.801
#grade=differentiate =>1
#n_stage = x6th_stage => 0.881
#n_stage = regional positive statu =>0.838073333
selected_data <- clean_data %>% select(-tumor_size, -grade,-n_stage,-reginol_node_positive,-x6th_stage)

corplot=cor(selected_data)
corrplot(corplot)
```

#Model fitting
```{R}
null_model = glm(status ~ 1, family = binomial(link = "logit"), data = selected_data)

model = glm(status ~ (. +age * race * marital_status -survival_months ),
             family = binomial(link = "logit"), data = selected_data)

step_modelF = step(null_model, scope = list(lower = null_model, upper = model))
                   
model = glm(status ~ (age * race * marital_status + t_stage + n_stage + x6th_stage + differentiate + grade + a_stage + tumor_size + estrogen_status + progesterone_status + regional_node_examined + regional_node_positive),
             family = binomial(link = "logit"), data = clean_data)


model = glm(status ~ (age * race * marital_status + t_stage + n_stage + x6th_stage + grade + a_stage + tumor_size  + regional_node_examined + regional_node_positive),
             family = binomial(link = "logit"), data = clean_data)


step_model = step(null_model, scope = list(lower = null_model, upper = model), 
                   direction = "forward")

step_model = step(model, direction = "backward")
summary(step_model)
summary(model)
summary(step_modelF)
```


```{r}
# Use windows or quartz
quartz(width = 12, height = 12)

pairs(clean_data)
```

```{r}
quartz(width = 12, height = 12)

corrplot(cor(clean_data), type = "upper", diag = FALSE)
```


```{r}
# Boxplots for each variable
par(mar = c(2, 2, 2, 2))
par(mfrow = c(4, 4))
boxplot(clean_data$age, main = "age")
boxplot(clean_data$race, main = "race")
boxplot(clean_data$marital_status, main = "marital_status")
boxplot(clean_data$t_stage, main = "t_stage")
boxplot(clean_data$n_stage, main = "n_stage")
boxplot(clean_data$x6th_stage, main = "x6th_stage")
boxplot(clean_data$differentiate, main = "differentiate")
boxplot(clean_data$grade, main = "grade")
boxplot(clean_data$a_stage, main = "a_stage")
boxplot(clean_data$tumor_size, main = "tumor_size")
boxplot(clean_data$estrogen_status, main = "estrogen_status")
boxplot(clean_data$progesterone_status, main = "progesterone_status")
boxplot(clean_data$regional_node_examined, main = "regional_node_examined")
boxplot(clean_data$regional_node_positive, main = "regional_node_positive")
boxplot(clean_data$survival_months, main = "survival_months")
boxplot(clean_data$status, main = "status")
```


```{r}
# Fit regression using all predictors
mult.fit = lm(survival_months ~., data = clean_data)
summary(mult.fit)
```

```{r}
# Histograms for each variable
par(mar = c(2, 2, 2, 2))
par(mfrow = c(4, 4))
hist(clean_data$age, main = "age")
hist(clean_data$race, main = "race")
hist(clean_data$marital_status, main = "marital_status")
hist(clean_data$t_stage, main = "t_stage")
hist(clean_data$n_stage, main = "n_stage")
hist(clean_data$x6th_stage, main = "x6th_stage")
hist(clean_data$differentiate, main = "differentiate")
hist(clean_data$grade, main = "grade")
hist(clean_data$a_stage, main = "a_stage")
hist(clean_data$tumor_size, main = "tumor_size")
hist(clean_data$estrogen_status, main = "estrogen_status")
hist(clean_data$progesterone_status, main = "progesterone_status")
hist(clean_data$regional_node_examined, main = "regional_node_examined")
hist(clean_data$regional_node_positive, main = "regional_node_positive")
hist(clean_data$survival_months, main = "survival_months")
hist(clean_data$status, main = "status")
```
